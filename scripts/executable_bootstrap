#!/usr/bin/env bash
# Bootstrap script for new machine setup

set -e

echo "==> Starting machine bootstrap..."

# ============================================================
# Package Installation
# ============================================================
echo ""
echo "==> Installing packages..."

PACKAGES=(
    claude-code
    tmux
    ghostty
    github-cli
    keyd
    telegram-desktop
)

sudo pacman -S --needed --noconfirm "${PACKAGES[@]}"

# ============================================================
# SSH Key Setup
# ============================================================
echo ""
echo "==> Setting up SSH key for GitHub..."

SSH_KEY="$HOME/.ssh/github"
if [ ! -f "$SSH_KEY" ]; then
    echo "Generating SSH key pair for GitHub..."
    ssh-keygen -t ed25519 -f "$SSH_KEY" -C "github" -N ""
    echo "SSH key generated at: $SSH_KEY"
    echo "Public key:"
    cat "${SSH_KEY}.pub"
else
    echo "SSH key already exists at: $SSH_KEY"
fi

# ============================================================
# Keyd Setup (CapsLock as Esc/Ctrl) - Laptop only
# ============================================================
# Check if this is a laptop by looking for battery in /sys/class/power_supply
if [ -d /sys/class/power_supply/BAT* ] 2>/dev/null || [ -d /sys/class/power_supply/BAT0 ] 2>/dev/null; then
    echo ""
    echo "==> Setting up keyd for CapsLock remapping (laptop detected)..."

    KEYD_CONFIG="/etc/keyd/default.conf"
    if [ ! -f "$KEYD_CONFIG" ]; then
        echo "Creating keyd configuration..."
        sudo mkdir -p /etc/keyd
        sudo tee "$KEYD_CONFIG" > /dev/null << 'EOF'
[ids]

*

[main]

capslock = overload(control, esc)
EOF
        echo "Enabling keyd service..."
        sudo systemctl enable --now keyd
    else
        echo "Keyd config already exists at: $KEYD_CONFIG"
    fi
else
    echo ""
    echo "==> Skipping keyd setup (desktop detected)"
fi

# ============================================================
# Tmux Plugin Manager Setup
# ============================================================
echo ""
echo "==> Setting up Tmux Plugin Manager (TPM)..."

TPM_DIR="$HOME/.config/tmux/plugins/tpm"
if [ ! -d "$TPM_DIR" ]; then
    echo "Installing TPM..."
    git clone https://github.com/tmux-plugins/tpm "$TPM_DIR"
else
    echo "TPM already installed, updating..."
    git -C "$TPM_DIR" pull
fi

echo "Installing tmux plugins..."
TMUX_PLUGIN_MANAGER_PATH="$HOME/.config/tmux/plugins" "$TPM_DIR/bin/install_plugins"

# ============================================================
# Done
# ============================================================
echo ""
echo "==> Bootstrap complete!"
